<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>管理後台</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css"> 
</head>
<body>

<div id="status-bar" data-i18n="status_disconnected">⚠️ 連線中斷，重連中...</div>

<div id="login-container">
    <div class="login-header">
        <h1 style="color:var(--primary);">Admin Console</h1><p style="color:var(--text-sub);">請登入系統</p>
    </div>
    <form onsubmit="return false;">
        <div class="control-group"><input type="text" id="username-input" placeholder="帳號" autocomplete="username" /></div>
        <div class="control-group"><input type="password" id="password-input" placeholder="密碼" autocomplete="current-password"/></div>
        <button id="login-button" type="submit" class="btn-primary">登入</button>
    </form>
    <p id="login-error"></p>
</div>

<div id="admin-panel" style="display:none;">
    
    <aside class="sidebar">
        <div class="sidebar-header"><div class="logo">⚡ 管理後台</div><div id="sidebar-user-info">Hi, Admin</div></div>
        <nav class="sidebar-nav">
            <button class="nav-btn active" data-target="section-live"><span class="nav-icon">🎮</span> 現場控台</button>
            <button class="nav-btn" data-target="section-stats"><span class="nav-icon">📈</span> 數據報表</button>
            <button class="nav-btn" data-target="section-settings"><span class="nav-icon">⚙️</span> 系統設定</button>
            <button class="nav-btn" data-target="section-line"><span class="nav-icon">💬</span> LINE設定</button>
        </nav>
        <div class="sidebar-footer">
            <select id="admin-lang-selector" class="lang-select"><option value="zh-TW">🇹🇼 繁中</option><option value="en">🇺🇸 EN</option></select>
        </div>
    </aside>

    <main class="content-area">
        <div id="section-live" class="section-group active">
            <div class="dashboard-header">
                <div class="dashboard-item"><span class="label">目前叫號</span><span class="value big-number" id="number">0</span></div>
                <div class="dashboard-item"><span class="label">已發號至</span><span class="value sub-number" id="issued-number">0</span></div>
                <div class="dashboard-item"><span class="label">等待組數</span><span class="value sub-number" id="waiting-count" style="color:var(--warning);">0</span></div>
            </div>

            <div class="card-container">
                <div class="card-wrapper full-width-card" id="card-calling">
                    <div class="admin-card">
                        <h3><span class="card-icon">📢</span> 叫號控制</h3>
                        <div class="big-action-row">
                            <button id="btn-call-prev" class="btn-glass btn-big">◀ 上一號</button>
                            <button id="btn-mark-passed" class="btn-warn btn-big">⏭️ 過號</button>
                            <button id="btn-call-next" class="btn-big" id="hero-btn">下一號 ▶</button>
                        </div>
                        <div class="control-group">
                            <label>指定/插隊</label>
                            <div style="display:flex; gap:8px; margin-bottom:8px;">
                                <button class="btn-secondary" id="quick-add-1" style="flex:1;">+1</button>
                                <button class="btn-secondary" id="quick-add-5" style="flex:1;">+5</button>
                                <button class="btn-secondary" id="quick-clear" style="flex:1; background:#f3f4f6;">C</button>
                            </div>
                            <div class="input-group">
                                <input type="number" id="manualNumber" placeholder="輸入號碼" inputmode="numeric" pattern="\d*"/>
                                <button id="setNumber" class="btn-secondary">執行</button>
                            </div>
                        </div>
                        <button id="resetNumber" class="btn-reset-single">↺ 重置叫號歸零</button>
                    </div>
                </div>

                <div class="card-wrapper" id="card-ticketing">
                    <div class="admin-card">
                        <h3><span class="card-icon">🎟️</span> 發號機</h3>
                        <div class="big-action-row">
                            <button id="btn-issue-prev" class="btn-glass btn-big">➖ 收回</button>
                            <button id="btn-issue-next" class="btn-success btn-big">發號 ➕</button>
                        </div>
                        <div class="control-group" style="margin-top:auto;">
                            <label>修正發號數</label>
                            <div class="input-group">
                                <input type="number" id="manualIssuedNumber" placeholder="#" inputmode="numeric"/>
                                <button id="setIssuedNumber" class="btn-secondary">修正</button>
                            </div>
                        </div>
                        <button id="resetIssued" class="btn-reset-single">↺ 重置發號歸零</button>
                    </div>
                </div>

                <div class="card-wrapper" id="card-editor">
                    <div class="admin-card">
                        <h3><span class="card-icon">📝</span> 過號名單</h3>
                        <div class="control-group list-editor">
                            <ul id="passed-list-ui"></ul>
                            <div class="input-group">
                                <input type="number" id="new-passed-number" placeholder="加入號碼" inputmode="numeric">
                                <button id="add-passed-btn" class="btn-add">+</button>
                            </div>
                        </div>
                        <button id="resetPassed" class="btn-reset-single">清空過號</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-stats" class="section-group">
            <div class="card-container">
                <div class="card-wrapper full-width-card">
                    <div class="admin-card">
                        <h3><span class="card-icon">📊</span> 流量分析</h3>
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div><p style="margin:0; color:var(--text-sub);">今日人次</p><span id="stats-today-count" style="font-size:2.2rem; font-weight:800; color:var(--primary);">0</span></div>
                            <div class="input-group" style="width:auto;"><button id="btn-refresh-stats" class="btn-secondary">重整</button><button id="btn-export-csv" class="btn-success btn-secondary" style="display:none; color:white;">下載 CSV</button></div>
                        </div>
                        <div id="hourly-chart" class="chart-container"><p style="margin:auto; color:#ccc;">Loading...</p></div>
                        <label style="margin-top:20px;">最近 100 筆</label>
                        <ul id="stats-list-ui" class="log-list"><li>Loading...</li></ul>
                        <button id="btn-clear-stats" class="btn-reset-single">⚠ 清空統計</button>
                    </div>
                </div>
                <div class="card-wrapper full-width-card">
                    <div class="admin-card">
                        <h3><span class="card-icon">📋</span> 日誌</h3>
                        <div class="control-group admin-log-container"><ul id="admin-log-ui" class="log-list"><li>Wait...</li></ul></div>
                        <button id="btn-clear-logs" class="btn-reset-single">清除日誌</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-settings" class="section-group">
            <div class="card-container">
                <div class="card-wrapper">
                    <div class="admin-card">
                        <h3><span class="card-icon">🔊</span> 音效廣播</h3>
                        <div class="control-group sound-toggle-group">
                            <label for="sound-toggle" style="cursor:pointer;">啟用提示音 (叮咚)</label>
                            <div class="toggle-wrapper"><input type="checkbox" id="sound-toggle"></div>
                        </div>
                        <div class="control-group">
                            <label>TTS 廣播</label>
                            <div class="input-group"><input type="text" id="broadcast-msg" placeholder="輸入文字..."><button id="btn-broadcast" class="btn-secondary">播放</button></div>
                        </div>
                    </div>
                </div>

                <div class="card-wrapper">
                    <div class="admin-card">
                        <h3><span class="card-icon">⚙️</span> 系統</h3>
                        <div class="control-group system-toggle-group">
                            <label for="public-toggle" style="cursor:pointer;">🌐 開放前台</label>
                            <input type="checkbox" id="public-toggle" checked>
                        </div>
                        <div id="mode-switcher-group" class="control-group form-group-boxed" style="display:none;">
                            <label>取號模式</label>
                            <div style="display:flex; gap:15px; margin-top:5px;">
                                <label><input type="radio" name="systemMode" value="ticketing" checked> 線上</label>
                                <label><input type="radio" name="systemMode" value="input"> 手動</label>
                            </div>
                        </div>
                        <button id="resetAll" class="btn-reset-single">💥 全域重置</button>
                    </div>
                </div>

                <div class="card-wrapper">
                    <div class="admin-card">
                        <h3><span class="card-icon">🟢</span> 在線管理</h3>
                        <div class="control-group list-editor" style="flex:1;"><ul id="online-users-list"><li>Loading...</li></ul></div>
                    </div>
                </div>

                <div class="card-wrapper full-width-card">
                    <div class="admin-card">
                        <h3><span class="card-icon">🔗</span> 連結管理</h3>
                        <div class="control-group list-editor">
                            <ul id="featured-list-ui"></ul>
                            <div class="input-group vertical">
                                <input type="text" id="new-link-text" placeholder="顯示名稱">
                                <div class="input-group"><input type="text" id="new-link-url" placeholder="URL"><button id="add-featured-btn" class="btn-add">+</button></div>
                            </div>
                            <button id="resetFeaturedContents" class="btn-reset-single">清空連結</button>
                        </div>
                    </div>
                </div>

                <div class="card-wrapper full-width-card" id="card-user-management" style="display:none;">
                    <div class="admin-card">
                        <h3><span class="card-icon">👥</span> 帳號管理</h3>
                        <div class="control-group list-editor">
                            <ul id="user-list-ui"></ul>
                            <label>新增帳號</label>
                            <div class="input-group vertical">
                                <div class="input-group"><input type="text" id="new-user-username" placeholder="帳號"><input type="text" id="new-user-nickname" placeholder="暱稱"></div>
                                <div class="input-group"><input type="password" id="new-user-password" placeholder="密碼"><button id="add-user-btn" class="btn-add">+</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-line" class="section-group">
            <div class="card-container">
                <div class="card-wrapper full-width-card">
                    <div class="admin-card">
                        <h3><span class="card-icon">💬</span> LINE 設定</h3>
                        <div class="control-group form-group-boxed" id="unlock-pwd-group" style="background:#fff7ed; display:none;">
                            <label style="color:#c2410c;">🔑 後台解鎖密碼</label>
                            <div class="input-group"><input type="text" id="line-unlock-pwd" placeholder="密碼"><button id="btn-save-unlock-pwd" class="btn-warn">儲存</button></div>
                        </div>
                        <details open>
                            <summary style="cursor:pointer; font-weight:700; padding:10px 0; color:var(--primary);">📌 主要通知</summary>
                            <div class="control-group form-group-boxed"><label>快到了 (前5號)</label><span class="var-hint">{current} {target} {diff}</span><textarea id="line-msg-approach"></textarea></div>
                            <div class="control-group form-group-boxed"><label>正式到號</label><span class="var-hint">{current} {target}</span><textarea id="line-msg-arrival"></textarea></div>
                        </details>
                        <details>
                            <summary style="cursor:pointer; font-weight:700; padding:10px 0; color:var(--text-sub);">🤖 關鍵字回覆</summary>
                            <div class="control-group form-group-boxed">
                                <label>查詢/Status</label><span class="var-hint">{current} {issued} {personal}</span><textarea id="line-msg-status" style="height:80px;"></textarea>
                                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
                                    <label style="font-size:0.85rem;">↳ 追蹤中附帶</label><span class="var-hint">{target} {diff}</span><textarea id="line-msg-personal" style="height:60px;"></textarea>
                                </div>
                            </div>
                            <div class="control-group form-group-boxed"><label>設定 (提示)</label><textarea id="line-msg-set_hint" style="height:60px;"></textarea></div>
                            <div class="control-group form-group-boxed"><label>設定 (成功)</label><span class="var-hint">{target} {current} {diff}</span><textarea id="line-msg-set_ok"></textarea></div>
                            <div class="control-group form-group-boxed"><label>登入提示</label><textarea id="line-msg-login-hint"></textarea></div>
                            <div class="control-group form-group-boxed"><label>錯誤:已過號</label><textarea id="line-msg-err-passed" style="height:60px;"></textarea></div>
                            <div class="control-group form-group-boxed"><label>錯誤:無追蹤</label><textarea id="line-msg-err-no-sub" style="height:60px;"></textarea></div>
                            <div class="control-group form-group-boxed"><label>取消成功</label><textarea id="line-msg-cancel" style="height:60px;"></textarea></div>
                            <div class="control-group form-group-boxed"><label>過號名單</label><textarea id="line-msg-passed" style="height:60px;"></textarea></div>
                        </details>
                        <div class="control-group" style="margin-top:20px; display:flex; gap:10px;">
                            <button id="btn-save-line-msg" class="btn-primary" style="flex:2;">儲存設定</button>
                            <button id="btn-reset-line-msg" class="btn-reset-single" style="flex:1;">恢復預設</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="edit-stats-overlay" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 style="margin-top:0;">編輯數據</h3>
        <div class="modal-actions">
            <button id="btn-stats-minus" class="btn-circle btn-warn">-1</button>
            <span id="modal-current-count" style="font-size:2.5rem; font-weight:800; min-width:60px;">0</span>
            <button id="btn-stats-plus" class="btn-circle btn-success">+1</button>
        </div>
        <button id="btn-modal-close" class="btn-secondary" style="width:100%;">完成</button>
    </div>
</div>

<div id="toast-notification"></div>
<script src="/js/admin.js"></script> 
</body>
</html>
